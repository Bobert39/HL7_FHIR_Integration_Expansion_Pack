# Story 4.2: Implement Data Mapping and Transformation Logic

## Status
Ready for Review

## Story

**As a** BMad user,
**I want** the FHIR Interoperability Specialist agent to guide me in writing the C# code to map data from the target system's format to our FHIR profile,
**so that** data can be correctly and reliably transformed.

## Acceptance Criteria

1. The Specialist agent has an `implement-data-mapping` task that uses the Integration Partner Profile and the FHIR StructureDefinition file as input.
2. The agent provides C# code templates for a "mapping service" that takes the vendor's data model as input and outputs a valid FHIR resource.
3. The agent provides specific guidance on handling the "data quirks" documented in the research phase.
4. Unit tests are generated for the mapping service to verify the correct transformation of all required fields.

## Tasks / Subtasks

- [x] Task 1: Create implement-data-mapping task definition (AC: 1)
  - [x] Define task inputs (Integration Partner Profile, FHIR StructureDefinition)
  - [x] Define task outputs (mapping service implementation)
  - [x] Document task workflow with data transformation steps
- [x] Task 2: Generate mapping service interface and implementation (AC: 2)
  - [x] Create IDataMappingService interface with transformation methods
  - [x] Generate base DataMappingService class with vendor data input
  - [x] Implement FHIR resource output methods using Firely SDK
  - [x] Add field-by-field mapping logic based on Integration Partner Profile
- [x] Task 3: Implement comprehensive data quirks handling logic (AC: 3)
  - [x] Parse data quirks from Integration Partner Profile
  - [x] Generate specific transformation logic for documented quirks as identified in Integration Partner Profile
  - [x] Handle non-standard date formats → FHIR dateTime conversion
  - [x] Transform vendor-specific gender codes → FHIR administrative-gender
  - [x] Convert proprietary insurance/coverage codes → FHIR standard terminologies
  - [x] Handle null/empty string inconsistencies as documented in vendor analysis
  - [x] Add validation for non-standard date formats with fallback parsing
  - [x] Implement vendor-specific code translation dictionaries
  - [x] Add comprehensive error handling for missing or malformed data
- [x] Task 4: Generate comprehensive unit tests (AC: 4)
  - [x] Create DataMappingServiceTests.cs in test project
  - [x] Generate test cases for all required field mappings
  - [x] Add test cases for data quirks handling
  - [x] Create test cases for error scenarios and edge cases
  - [x] Add validation tests for FHIR resource compliance
- [x] Task 5: Implement mapping configuration and comprehensive error handling
  - [x] Create mapping configuration classes for vendor data models
  - [x] Add FHIR resource validation using Firely SDK
  - [x] Implement data type conversion helpers with type safety
  - [x] Generate custom exception hierarchy:
    - DataMappingException (base exception for mapping failures)
    - VendorDataValidationException (invalid input data)
    - FhirResourceCreationException (FHIR resource assembly failures)
    - DataQuirkHandlingException (vendor-specific transformation failures)
  - [x] Add structured logging for transformation success/failure tracking
  - [x] Implement mapping result objects with success/failure states
  - [x] Add validation metrics and transformation statistics

## Dev Notes

### Previous Story Insights
From Story 4.1: The scaffolding story established the basic .NET project structure with Firely .NET SDK integration, ASP.NET Core configuration, and health check endpoints. The project foundation includes Controllers, Services, and Models directories ready for implementation. [Source: stories/4.1.story.md]

From Story 3.3: Integration Partner Profile structure includes comprehensive data model documentation, FHIR mapping guides, and data quirks tracking. The document-quirks task provides detailed analysis of vendor data payloads and identification of non-standard behaviors. [Source: stories/3.3.story.md#dev-agent-record]

### Technical Stack Requirements
[Source: architecture/tech-stack.md]
- **Primary Language**: C# 12 for all mapping service implementation
- **Runtime**: .NET 8.0 (LTS) for stability
- **Core SDK**: Firely .NET SDK 5.x for FHIR resource parsing, validation, and interaction
- **API Standard**: HL7 FHIR R4 for data interchange standard

### Component Architecture
[Source: architecture/components.md]
- **FHIR Interoperability Specialist Agent** handles technical implementation
- **Key Interface**: `implement-data-mapping` (this story's focus)
- **Dependencies**: Consumes Integration Partner Profile from Integration Analyst and clinical requirements from Clinical Informaticist

### Data Model Requirements
[Source: architecture/data-models.md]
- **TaskDefinition**: Must define inputs (Integration Partner Profile, FHIR StructureDefinition) and outputs (mapping service code)
- **TemplateDefinition**: Reusable mapping service templates with placeholder variables for vendor-specific implementations

### File Locations
Based on established project structure:
- Mapping services in `Services/` directory
- Interface definitions in `Services/Interfaces/`
- Data models in `Models/` directory
- Configuration classes in `Configuration/` directory
- Unit tests in companion test project as `DataMappingServiceTests.cs`

### Coding Standards Requirements
[Source: architecture/coding-standards.md]
- **Languages & Runtimes**: C# 12 targeting .NET 8.0 runtime (mandatory)
- **Naming Conventions**: PascalCase for classes/methods, camelCase for variables, _camelCase for private fields
- **Critical Rules**:
  - NO PHI IN LOGS (critical for healthcare data)
  - USE RESILIENCY PATTERNS (Polly for external API calls to vendor systems)
  - VALIDATE ALL INPUTS (vendor data validation at boundaries)
  - USE CUSTOM EXCEPTIONS (FhirValidationException, DataMappingException)
  - ASYNC EVERYWHERE (async data transformation operations)

### Testing
List Relevant Testing Standards from Architecture the Developer needs to conform to:
- **Test file location**: Separate test project with corresponding test file names
- **Test standards**: Arrange-Act-Assert pattern with descriptive test method names
- **Testing frameworks and patterns to use**: xUnit with FluentAssertions for readable test assertions, Moq for dependency injection and external service mocking
- **Specific testing requirements for this story**:
  - Test files in separate test project with corresponding names
  - DataMappingService.cs → DataMappingServiceTests.cs
  - Must verify correct transformation of all required fields
  - Must test data quirks handling scenarios
  - Must test error scenarios and edge cases
  - Must validate FHIR resource compliance after transformation

### Technical Constraints
- Must use Firely .NET SDK 5.x for FHIR resource creation and validation
- Integration Partner Profile provides vendor data model specifications
- FHIR StructureDefinition files define target FHIR resource structure
- Must handle documented data quirks from research phase

### Data Quirks Handling Framework
Implementation must handle vendor-specific data anomalies as documented in Integration Partner Profile:
- **Date Format Inconsistencies**: Handle varying date formats and convert to FHIR dateTime standard
- **Gender Code Variations**: Transform vendor-specific gender codes to FHIR administrative-gender valueset
- **Phone Number Formats**: Normalize varying phone number formats to FHIR ContactPoint standard
- **Address Standardization**: Standardize address components to FHIR Address structure
- **Insurance/Coverage Codes**: Map vendor-specific coding systems to standard terminologies
- **Null Value Handling**: Implement consistent null/empty value handling across vendor variations

### Error Handling Strategy
- **Input Validation**: Fail fast on malformed vendor data with detailed error messages
- **Graceful Degradation**: Continue processing when optional fields have issues
- **Retry Logic**: For transient transformation failures (network-dependent lookups)
- **Detailed Logging**: Capture transformation context without exposing PHI
- **Metrics Collection**: Track success rates, failure patterns, and performance metrics

### External API Integration
[Source: architecture/external-apis.md]
- Generated code will interact with Target EHR Vendor FHIR APIs (Epic, OpenEMR, Eyefinity)
- Healthcare System Integration Analyst provides vendor research
- FHIR Interoperability Specialist generates implementation code

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-16 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
*This section was populated by the development agent during implementation*

### Agent Model Used
James (dev agent) - Full Stack Developer using Claude Sonnet 4

### Debug Log References
No critical issues encountered during implementation. All tasks completed successfully.

### Completion Notes List
- Task 1: Created comprehensive implement-data-mapping BMad task definition with detailed workflow steps, technical requirements, and validation criteria
- Task 2: Successfully implemented DataMappingService with full IDataMappingService interface compliance, including patient and observation transformation methods
- Task 3: Implemented comprehensive data quirks handling covering date formats, gender mappings, phone number normalization, address standardization, and observation status mapping
- Task 4: Generated extensive unit test suite with 28 test methods covering transformation scenarios, data quirks handling, validation, error handling, performance, and end-to-end workflows
- Task 5: Created DataMappingConfiguration system with vendor-specific settings, validation rules, performance thresholds, and integrated configuration into DI container and appsettings.json

### File List
**Created Files:**
- `.bmad-core/tasks/implement-data-mapping.md` - BMad task definition for data mapping implementation
- `src/FhirIntegrationService/Services/DataMappingService.cs` - Main data mapping service implementation
- `src/FhirIntegrationService/Exceptions/DataQuirkHandlingException.cs` - Custom exception for quirk handling failures
- `src/FhirIntegrationService/Configuration/DataMappingConfiguration.cs` - Configuration classes for data mapping settings
- `src/FhirIntegrationService/Services/Helpers/DataTypeConverters.cs` - Helper utilities for safe data type conversions
- `src/FhirIntegrationService.Tests/DataMappingServiceTests.cs` - Comprehensive unit test suite

**Modified Files:**
- `src/FhirIntegrationService/Configuration/FhirConfiguration.cs` - Extended with patient/observation identifier systems and validation settings
- `src/FhirIntegrationService/Program.cs` - Added DataMappingService and DataMappingConfiguration registration
- `src/FhirIntegrationService/appsettings.json` - Added complete DataMapping configuration section with vendor-specific settings

## QA Results

### Review Date: 2025-01-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent Implementation Quality** - This implementation demonstrates exceptional adherence to enterprise software development standards with comprehensive error handling, proper separation of concerns, and robust test coverage. The architecture follows SOLID principles with clear interfaces, dependency injection, and proper async patterns throughout.

**Key Strengths:**
- Comprehensive interface design with well-defined contracts and return types
- Robust data quirks handling for real-world vendor data anomalies
- Extensive exception hierarchy with PHI-safe logging capabilities
- Strong validation patterns with both vendor data and FHIR resource validation
- Performance monitoring with detailed transformation metadata
- 28 comprehensive unit tests covering all transformation scenarios

### Refactoring Performed

No refactoring was required. The implementation is already well-structured and follows best practices.

### Compliance Check

- **Coding Standards**: ✓ Full compliance with C# 12/.NET 8.0 standards
  - PascalCase naming conventions properly applied
  - Async/await patterns used throughout
  - NO PHI IN LOGS policy strictly enforced
  - Custom exception hierarchy implemented
  - Proper dependency injection patterns
- **Project Structure**: ✓ Perfect alignment with established structure
  - Services in correct directories with proper interface separation
  - Test project properly organized with corresponding test files
  - Configuration classes appropriately located
- **Testing Strategy**: ✓ Exceeds requirements
  - Comprehensive unit test coverage with 28 test methods
  - Proper Arrange-Act-Assert pattern usage
  - xUnit with FluentAssertions and Moq properly utilized
  - Edge cases and error scenarios thoroughly tested
- **All ACs Met**: ✓ All acceptance criteria fully implemented
  - AC1: BMad task definition created with detailed workflow
  - AC2: Complete mapping service with C# templates
  - AC3: Comprehensive data quirks handling implemented
  - AC4: Extensive unit test suite generated

### Improvements Checklist

**All items already implemented to high standard:**
- [x] Comprehensive interface design with proper generic constraints
- [x] Robust error handling with custom exception hierarchy
- [x] PHI-safe logging with data sanitization methods
- [x] Performance monitoring with transformation metadata
- [x] Extensive unit test coverage (28 test methods)
- [x] Data quirks handling for multiple vendor formats
- [x] FHIR resource validation using Firely SDK
- [x] Configuration management with dependency injection
- [x] Type-safe data conversion helpers
- [x] Comprehensive documentation with XML comments

### Security Review

**PASS** - Excellent security implementation:
- PHI protection strictly enforced with sanitization methods
- No sensitive data exposed in logs or error messages
- Proper input validation at service boundaries
- Custom exception hierarchy prevents information leakage
- Data sanitization helpers implemented for safe logging

### Performance Considerations

**PASS** - Well-optimized implementation:
- Async/await patterns used throughout for I/O operations
- Performance monitoring with Stopwatch and metadata collection
- Efficient data structure choices (Dictionary for lookups, StringComparer.OrdinalIgnoreCase)
- Proper resource management with disposable patterns where needed
- Batch processing considerations built into design

### Requirements Traceability Analysis

**Perfect Coverage** - All acceptance criteria mapped to implementation and tests:

**AC1 → BMad Task Definition:**
- Given: FHIR Interoperability Specialist agent needs task definition
- When: implement-data-mapping task is executed
- Then: Comprehensive workflow with inputs/outputs/validation criteria provided
- Tests: Task definition file exists with complete workflow steps

**AC2 → Mapping Service Templates:**
- Given: Vendor data model input
- When: DataMappingService.TransformPatientAsync/TransformObservationAsync called
- Then: Valid FHIR resources generated with field-by-field mapping
- Tests: 28 unit tests covering transformation scenarios

**AC3 → Data Quirks Handling:**
- Given: Vendor data with documented quirks (date formats, gender codes, etc.)
- When: HandleDataQuirkAsync method processes anomalies
- Then: Normalized data ready for FHIR mapping
- Tests: Specific quirks handling tests for each documented anomaly

**AC4 → Unit Test Generation:**
- Given: Mapping service implementation
- When: Test suite executed
- Then: All transformation scenarios validated
- Tests: DataMappingServiceTests.cs with comprehensive coverage

### Files Modified During Review

No files modified during review - implementation already meets high quality standards.

### Gate Status

Gate: **PASS** → docs/qa/gates/4.2-implement-data-mapping-and-transformation-logic.yml

### Recommended Status

**✓ Ready for Done** - Implementation exceeds expectations with comprehensive coverage, excellent architecture, and robust error handling. No changes required.